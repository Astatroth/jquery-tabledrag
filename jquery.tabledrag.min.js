(function(a,b){var c={};a.fn.tableDrag=function(b){b=a.extend({draggableClass:"draggable",cookiePath:"/",group:{fieldClass:"row-depth",depthLimit:3},weight:{fieldClass:"row-weight",hidden:!0},parent:{fieldClass:"row-parent",sourceFieldClass:"person-id",hidden:!0}},b||{}),this.each(function(){new c.tableDrag(this,b),a("tr."+b.draggableClass,this).each(function(){var d=a(this);if(b.group.fieldClass){var e=a("."+b.group.fieldClass,d);if(e.length)for(var f=1,g=e.val();g>f;f++)a("td:first",d).prepend(c.theme("tableDragIndentation"))}})})},c.tableDrag=function(b,d){var e=this;if(this.table=b,this.tableSettings=d,this.dragObject=null,this.rowObject=null,this.oldRowElement=null,this.oldY=0,this.changed=!1,this.maxDepth=0,this.rtl="rtl"==a(this.table).css("direction")?-1:1,this.scrollSettings={amount:4,interval:50,trigger:70},this.scrollInterval=null,this.scrollY=0,this.windowHeight=0,this.indentEnabled=!!d.parent.fieldClass,this.maxDepth=this.indentEnabled?d.group.depthLimit:this.maxDepth,this.indentEnabled){this.indentCount=1;var f=c.theme("tableDragIndentation"),g=a("<tr/>").addClass(this.tableSettings.draggableClass).appendTo(b),h=a("<td/>").appendTo(g).prepend(f).prepend(f);this.indentAmount=a(".indentation",h).get(1).offsetLeft-a(".indentation",h).get(0).offsetLeft,g.remove()}a("> tr."+this.tableSettings.draggableClass+", > tbody > tr."+this.tableSettings.draggableClass,b).each(function(){e.makeDraggable(this)}),a(b).before(a('<a href="#" class="tabledrag-toggle-weight"></a>').attr("title",c.t("Re-order rows by numerical weight/parent instead of dragging.")).click(function(){return 1==a.cookie("Drupal.tableDrag.showWeight")?e.hideColumns():e.showColumns(),!1}).wrap('<div class="tabledrag-toggle-weight-wrapper"></div>').parent()),e.initColumns(),a(document).bind("mousemove",function(a){return e.dragRow(a,e)}),a(document).bind("mouseup",function(a){return e.dropRow(a,e)})},c.tableDrag.prototype.initColumns=function(){for(var c in{group:1,weight:1,parent:1}){if(this.tableSettings[c].fieldClass!==b){var d=a("."+this.tableSettings[c].fieldClass+":first",this.table);if(d.length&&this.tableSettings[c].hidden)var e=this.tableSettings[c].hidden,f=d.closest("td")}if(e&&f[0]){var g=a("> td",f.parent()).index(f.get(0))+1;a("> thead > tr, > tbody > tr, > tr",this.table).each(function(){var b=g,c=a(this).children();c.each(function(a){b>a&&this.colSpan&&this.colSpan>1&&(b-=this.colSpan-1)}),b>0&&(f=c.filter(":nth-child("+b+")"),f[0].colSpan&&f[0].colSpan>1?f.addClass("tabledrag-has-colspan"):f.addClass("tabledrag-hide"))})}}null===a.cookie("Drupal.tableDrag.showWeight")?(a.cookie("Drupal.tableDrag.showWeight",0,{path:this.tableSettings.cookiePath,expires:365}),this.hideColumns()):1==a.cookie("Drupal.tableDrag.showWeight")?this.showColumns():this.hideColumns()},c.tableDrag.prototype.hideColumns=function(){a(".tabledrag-hide",this.table).css("display","none"),a(".tabledrag-handle",this.table).css("display",""),a(".tabledrag-has-colspan",this.table).each(function(){this.colSpan=this.colSpan-1}),a(".tabledrag-toggle-weight").text(c.t("Show row weights/parents")),a.cookie("Drupal.tableDrag.showWeight",0,{path:this.tableSettings.cookiePath,expires:365}),a(this.table).trigger("columnschange","hide")},c.tableDrag.prototype.showColumns=function(){a(".tabledrag-hide",this.table).css("display",""),a(".tabledrag-handle",this.table).css("display","none"),a(".tabledrag-has-colspan",this.table).each(function(){this.colSpan=this.colSpan+1}),a(".tabledrag-toggle-weight").text(c.t("Hide row weights/parents")),a.cookie("Drupal.tableDrag.showWeight",1,{path:this.tableSettings.cookiePath,expires:365}),a(this.table).trigger("columnschange","show")},c.tableDrag.prototype.rowSettings=function(c,d){if(this.tableSettings[c].fieldClass!==b){var e=a("."+this.tableSettings[c].fieldClass,d);if(e.length){var f=this.tableSettings[c];return f.relationship="group"==c?"group":"parent"==c?"parent":"weight"==c?"sibling":"self",f.action="group"==c?"depth":"parent"==c?"match":"weight"==c?"order":"order",f}}},c.tableDrag.prototype.makeDraggable=function(d){var e=this,f=a('<a href="#" class="tabledrag-handle"><div class="handle">&nbsp;</div></a>').attr("title",c.t("Drag to re-order"));a("td:first .indentation:last",d).length?(a("td:first .indentation:last",d).after(f),e.indentCount=Math.max(a(".indentation",d).length,e.indentCount)):a("td:first",d).prepend(f),f.hover(function(){null==e.dragObject?a(this).addClass("tabledrag-handle-hover"):null},function(){null==e.dragObject?a(this).removeClass("tabledrag-handle-hover"):null}),f.mousedown(function(b){return e.dragObject={},e.dragObject.initMouseOffset=e.getMouseOffset(d,b),e.dragObject.initMouseCoords=e.mouseCoords(b),e.indentEnabled&&(e.dragObject.indentMousePos=e.dragObject.initMouseCoords),e.rowObject&&a("a.tabledrag-handle",e.rowObject.element).blur(),e.rowObject=new e.row(d,"mouse",e.indentEnabled,e.maxDepth,!0,e.tableSettings.draggableClass),e.table.topY=a(e.table).offset().top,e.table.bottomY=e.table.topY+e.table.offsetHeight,a(this).addClass("tabledrag-handle-hover"),a(d).addClass("drag"),a("body").addClass("drag"),e.oldRowElement&&a(e.oldRowElement).removeClass("drag-previous"),-1!=navigator.userAgent.indexOf("MSIE 6.")&&a("select",this.table).css("display","none"),e.safeBlur=!1,e.onDrag(),!1}),f.click(function(){return!1}),f.focus(function(){a(this).addClass("tabledrag-handle-hover"),e.safeBlur=!0}),f.blur(function(b){a(this).removeClass("tabledrag-handle-hover"),e.rowObject&&e.safeBlur&&e.dropRow(b,e)}),f.keydown(function(c){9==c.keyCode||e.rowObject||(e.rowObject=new e.row(d,"keyboard",e.indentEnabled,e.maxDepth,!0,e.tableSettings.draggableClass));var g=!1;switch(c.keyCode){case 37:case 63234:g=!0,e.rowObject.indent(-1*e.rtl);break;case 38:case 63232:for(var h=a(e.rowObject.element).prev("tr").get(0);h&&a(h).is(":hidden");)h=a(h).prev("tr").get(0);if(h){if(e.safeBlur=!1,e.rowObject.direction="up",g=!0,a(d).is(".tabledrag-root")){for(var i=0;h&&a(".indentation",h).length;)h=a(h).prev("tr").get(0),i+=a(h).is(":hidden")?0:h.offsetHeight;h&&(e.rowObject.swap("before",h),window.scrollBy(0,-i))}else(e.table.tBodies[0].rows[0]!=h||a(h).is("."+e.tableSettings.draggableClass))&&(e.rowObject.swap("before",h),e.rowObject.interval=null,e.rowObject.indent(0),window.scrollBy(0,-parseInt(d.offsetHeight,10)));f.get(0).focus()}break;case 39:case 63235:g=!0,e.rowObject.indent(1*e.rtl);break;case 40:case 63233:for(var j=a(e.rowObject.group).filter(":last").next("tr").get(0);j&&a(j).is(":hidden");)j=a(j).next("tr").get(0);if(j){if(e.safeBlur=!1,e.rowObject.direction="down",g=!0,a(d).is(".tabledrag-root")){var i=0,k=new e.row(j,"keyboard",e.indentEnabled,e.maxDepth,!1,e.tableSettings.draggableClass);if(k){a(k.group).each(function(){i+=a(this).is(":hidden")?0:this.offsetHeight});var l=a(k.group).filter(":last").get(0);e.rowObject.swap("after",l),window.scrollBy(0,parseInt(i,10))}}else e.rowObject.swap("after",j),e.rowObject.interval=null,e.rowObject.indent(0),window.scrollBy(0,parseInt(d.offsetHeight,10));f.get(0).focus()}}return e.rowObject&&1==e.rowObject.changed&&(a(d).addClass("drag"),e.oldRowElement&&a(e.oldRowElement).removeClass("drag-previous"),e.oldRowElement=d,e.restripeTable(),e.onDrag()),g?!1:b}),f.keypress(function(a){switch(a.keyCode){case 37:case 38:case 39:case 40:return!1}})},c.tableDrag.prototype.dragRow=function(a,b){if(b.dragObject){b.currentMouseCoords=b.mouseCoords(a);var c=b.currentMouseCoords.y-b.dragObject.initMouseOffset.y,d=b.currentMouseCoords.x-b.dragObject.initMouseOffset.x;if(c!=b.oldY){b.rowObject.direction=c>b.oldY?"down":"up",b.oldY=c;var e=b.checkScroll(b.currentMouseCoords.y);clearInterval(b.scrollInterval),(e>0&&"down"==b.rowObject.direction||0>e&&"up"==b.rowObject.direction)&&b.setScroll(e);var f=b.findDropTargetRow(d,c);f&&("down"==b.rowObject.direction?b.rowObject.swap("after",f,b):b.rowObject.swap("before",f,b),b.restripeTable())}if(b.indentEnabled){var g=b.currentMouseCoords.x-b.dragObject.indentMousePos.x,h=Math.round(g/b.indentAmount*b.rtl),i=b.rowObject.indent(h);b.dragObject.indentMousePos.x+=b.indentAmount*i*b.rtl,b.indentCount=Math.max(b.indentCount,b.rowObject.indents)}return!1}},c.tableDrag.prototype.dropRow=function(b,c){if(null!=c.rowObject){var d=c.rowObject.element;if(1==c.rowObject.changed){if(c.updateFields(d),c.tableSettings.group.fieldClass)for(var e in c.rowObject.children)c.updateField(c.rowObject.children[e],"group");0==c.changed&&(c.changed=!0)}c.indentEnabled&&c.rowObject.removeIndentClasses(),c.oldRowElement&&a(c.oldRowElement).removeClass("drag-previous"),a(d).removeClass("drag").addClass("drag-previous"),c.oldRowElement=d,c.onDrop(),c.rowObject=null}null!=c.dragObject&&(a(".tabledrag-handle",d).removeClass("tabledrag-handle-hover"),c.dragObject=null,a("body").removeClass("drag"),clearInterval(c.scrollInterval),-1!=navigator.userAgent.indexOf("MSIE 6.")&&a("select",this.table).css("display","block"))},c.tableDrag.prototype.mouseCoords=function(a){return a.pageX||a.pageY?{x:a.pageX,y:a.pageY}:{x:a.clientX+document.body.scrollLeft-document.body.clientLeft,y:a.clientY+document.body.scrollTop-document.body.clientTop}},c.tableDrag.prototype.getMouseOffset=function(b,c){var d=a(b).offset(),e=this.mouseCoords(c);return{x:e.x-d.left,y:e.y-d.top}},c.tableDrag.prototype.findDropTargetRow=function(b,c){for(var d=a(this.table.tBodies[0].rows).not(":hidden"),e=0;d.length>e;e++){var f=d[e],h=a(f).offset().top;if(0==f.offsetHeight)var i=parseInt(f.firstChild.offsetHeight,10)/2;else var i=parseInt(f.offsetHeight,10)/2;if(c>h-i&&h+i>c){if(this.indentEnabled){for(var e in this.rowObject.group)if(this.rowObject.group[e]==f)return null}else if(f==this.rowObject.element)return null;if(!this.rowObject.isValidSwap(f))return null;for(;a(f).is(":hidden")&&a(f).prev("tr").is(":hidden");)f=a(f).prev("tr").get(0);return f}}return null},c.tableDrag.prototype.updateFields=function(a){for(var b in{group:1,weight:1,parent:1})this.updateField(a,b)},c.tableDrag.prototype.updateField=function(b,c){var d=this.rowSettings(c,b);if("self"==d.relationship||"group"==d.relationship)var e=b;else if("sibling"==d.relationship){var f=a(b).prev("tr").get(0),g=a(b).next("tr").get(0),e=b;a(f).is("."+this.tableSettings.draggableClass)&&a("."+c,f).length?this.indentEnabled?a(".indentations",f).length==a(".indentations",b)&&(e=f):e=f:a(g).is("."+this.tableSettings.draggableClass)&&a("."+c,g).length&&(this.indentEnabled?a(".indentations",g).length==a(".indentations",b)&&(e=g):e=g)}else if("parent"==d.relationship){for(var f=a(b).prev("tr");f.length&&a(".indentation",f).length>=this.rowObject.indents;)f=f.prev("tr");if(f.length)e=f[0];else{e=a(this.table).find("tr."+this.tableSettings.draggableClass+":first").get(0),e==this.rowObject.element&&(e=a(this.rowObject.group[this.rowObject.group.length-1]).next("tr."+this.tableSettings.draggableClass).get(0));var h=!0}}this.copyDragClasses(e,b,c),d=this.rowSettings(c,b),h&&(d.relationship="sibling",d.source=d.fieldClass);var i="."+d.fieldClass,j=a(i,b);if(j){var k="."+("parent"==d.relationship?d.sourceFieldClass:d.fieldClass),l=a(k,e);switch(d.action){case"depth":j.val(a(".indentation",l.closest("tr")).length);break;case"match":j.val(l.val());break;case"order":var m=this.rowObject.findSiblings(d);if(j.is("select")){var n=[];a("option",j).each(function(){n.push(this.value)});var o=n[n.length-1];a(i,m).each(function(){this.value=n.length>0?n.shift():o})}else{var p=parseInt(a(i,m[0]).val(),10)||0;a(i,m).each(function(){this.value=p,p++})}}}},c.tableDrag.prototype.copyDragClasses=function(b,c,d){var e=a("."+d,b),f=a("."+d,c);e.length&&f.length&&(f[0].className=e[0].className)},c.tableDrag.prototype.checkScroll=function(a){var c=document.documentElement,d=document.body,e=this.windowHeight=window.innerHeight||(c.clientHeight&&0!=c.clientWidth?c.clientHeight:d.offsetHeight),f=this.scrollY=document.all?c.scrollTop?c.scrollTop:d.scrollTop:window.pageYOffset?window.pageYOffset:window.scrollY,g=this.scrollSettings.trigger,h=0;return a-f>e-g?(h=g/(e+f-a),h=h>0&&g>h?h:g,h*this.scrollSettings.amount):g>a-f?(h=g/(a-f),h=h>0&&g>h?h:g,-h*this.scrollSettings.amount):b},c.tableDrag.prototype.setScroll=function(a){var b=this;this.scrollInterval=setInterval(function(){b.checkScroll(b.currentMouseCoords.y);var c=b.scrollY>b.table.topY,d=b.scrollY+b.windowHeight<b.table.bottomY;(a>0&&d||0>a&&c)&&window.scrollBy(0,a)},this.scrollSettings.interval)},c.tableDrag.prototype.restripeTable=function(){a("> tbody > tr."+this.tableSettings.draggableClass+":visible, > tr."+this.tableSettings.draggableClass+":visible",this.table).removeClass("odd even").filter(":odd").addClass("even").end().filter(":even").addClass("odd")},c.tableDrag.prototype.onDrag=function(){return null},c.tableDrag.prototype.onDrop=function(){return null},c.tableDrag.prototype.row=function(b,c,d,e,f,g){if(this.element=b,this.method=c,this.group=[b],this.groupDepth=a(".indentation",b).length,this.changed=!1,this.table=a(b).closest("table").get(0),this.indentEnabled=d,this.maxDepth=e,this.direction="",this.draggableClass=g,this.indentEnabled){this.indents=a(".indentation",b).length,this.children=this.findChildren(f),this.group=a.merge(this.group,this.children);for(var h=0;this.group.length>h;h++)this.groupDepth=Math.max(a(".indentation",this.group[h]).length,this.groupDepth)}},c.tableDrag.prototype.row.prototype.findChildren=function(b){for(var c=this.indents,d=a(this.element,this.table).next("tr."+this.draggableClass),e=[],f=0;d.length;){var g=a(".indentation",d).length;if(!(g>c))break;f++,e.push(d[0]),b&&a(".indentation",d).each(function(b){1==f&&b==c&&a(this).addClass("tree-child-first"),b==c?a(this).addClass("tree-child"):b>c&&a(this).addClass("tree-child-horizontal")}),d=d.next("tr."+this.draggableClass)}return b&&e.length&&a(".indentation:nth-child("+(c+1)+")",e[e.length-1]).addClass("tree-child-last"),e},c.tableDrag.prototype.row.prototype.isValidSwap=function(b){if(this.indentEnabled){var c,d;if("down"==this.direction?(c=b,d=a(b).next("tr").get(0)):(c=a(b).prev("tr").get(0),d=b),this.interval=this.validIndentInterval(c,d),this.interval.min>this.interval.max)return!1}return this.table.tBodies[0].rows[0]==b&&a(b).is(":not(."+this.draggableClass+")")?!1:!0},c.tableDrag.prototype.row.prototype.swap=function(b,c){a(c)[b](this.group),this.changed=!0,this.onSwap(c)},c.tableDrag.prototype.row.prototype.validIndentInterval=function(b,c){var d,e;return d=c?a(".indentation",c).length:0,!b||a(b).is(":not(."+this.draggableClass+")")||a(this.element).is(".tabledrag-root")?e=0:(e=a(".indentation",b).length+(a(b).is(".tabledrag-leaf")?0:1),this.maxDepth&&(e=Math.min(e,this.maxDepth-(this.groupDepth-this.indents)))),{min:d,max:e}},c.tableDrag.prototype.row.prototype.indent=function(b){if(!this.interval){var d=a(this.element).prev("tr").get(0),e=a(this.group).filter(":last").next("tr").get(0);this.interval=this.validIndentInterval(d,e)}var f=this.indents+b;f=Math.max(f,this.interval.min),f=Math.min(f,this.interval.max),b=f-this.indents;for(var g=1;Math.abs(b)>=g;g++)0>b?(a(".indentation:first",this.group).remove(),this.indents--):(a("td:first",this.group).prepend(c.theme("tableDragIndentation")),this.indents++);return b&&(this.changed=!0,this.groupDepth+=b,this.onIndent()),b},c.tableDrag.prototype.row.prototype.findSiblings=function(b){for(var c=[],d=["prev","next"],e=this.indents,f=0;d.length>f;f++){for(var g=a(this.element)[d[f]]();g.length&&a("."+b.target,g);){if(this.indentEnabled)var h=a(".indentation",g).length;if(this.indentEnabled&&h!=e){if(e>h)break}else c.push(g[0]);g=a(g)[d[f]]()}"prev"==d[f]&&(c.reverse(),c.push(this.element))}return c},c.tableDrag.prototype.row.prototype.removeIndentClasses=function(){for(var b in this.children)a(".indentation",this.children[b]).removeClass("tree-child").removeClass("tree-child-first").removeClass("tree-child-last").removeClass("tree-child-horizontal")},c.tableDrag.prototype.row.prototype.onIndent=function(){return null},c.tableDrag.prototype.row.prototype.onSwap=function(){return null},c.t=function(a){return a},c.theme=function(a){var b=Array.prototype.slice.apply(arguments,[1]);return(c.theme[a]||c.theme.prototype[a]).apply(this,b)},c.theme.prototype.tableDragChangedMarker=function(){return'<span class="warning tabledrag-changed">*</span>'},c.theme.prototype.tableDragIndentation=function(){return'<div class="indentation">&nbsp;</div>'}})(jQuery);